<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Twilight Imperium IV — Game Log</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1720;
      --panel-2: #0c131c;
      --text: #e6edf3;
      --muted: #93a0ad;
      --muted-2: #7a8896; /* rodapé mais escuro */
      --border: #1e2937;
      --accent: #60a5fa;
      --accent-2: #22d3ee;
      --ok: #10b981;
      --danger: #ef4444;
      --warn: #f59e0b;
    }
    *{ box-sizing:border-box }
    html, body{
      height:100%;
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background: linear-gradient(180deg, #0a0f14 0%, #0b1016 100%);
      color: var(--text);
    }
    .container{
      max-width:600px; margin:0 auto; padding:40px 20px; min-height:100vh;
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;
    }
    .logo{
      font-size:2.5rem; font-weight:800; margin-bottom:8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    }
    .subtitle{ color:var(--muted); font-size:1.1rem; margin-bottom:20px; line-height:1.5; }

    /* bloco do top faction logo abaixo do subtítulo */
    .top-faction{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:8px; margin:10px 0 24px;
    }
    .top-faction img{
      width:72px; height:72px; object-fit:contain; image-rendering:auto;
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
    }
    .top-faction .tf-text{
      font-size:.9rem; color:var(--muted);
    }

    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border); border-radius:16px; padding:32px;
      box-shadow:0 6px 22px rgba(0,0,0,.28); width:100%; max-width:500px;
    }

    .block + .block{ margin-top:24px; }

    .btn{
      background: linear-gradient(90deg, rgba(96,165,250,.18), rgba(96,165,250,.10));
      border:1px solid #334155; border-radius:12px; padding:16px 24px;
      font-size:1.1rem; color:var(--text); cursor:pointer; transition:all .15s ease;
      text-decoration:none; display:inline-block; width:100%; margin:12px 0;
    }
    .btn:hover{
      background:linear-gradient(90deg, rgba(96,165,250,.25), rgba(96,165,250,.15));
      border-color:#475569; transform:translateY(-1px);
    }
    .btn.secondary{ background:transparent; border-color:var(--border); }
    .btn.secondary:hover{
      background:linear-gradient(90deg, rgba(96,165,250,.25), rgba(96,165,250,.15));
      border-color:#475569; transform:translateY(-1px);
    }

    .input-group{ margin:20px 0; text-align:left; }
    .input-group label{ display:block; color:var(--muted); font-size:.9rem; margin-bottom:6px; }
    .input-group input{
      width:100%; background:#0b121a; color:var(--text); border:1px solid var(--border);
      border-radius:12px; padding:12px; font-size:1rem; outline:none;
    }
    .input-group input:focus{ border-color:#334155; box-shadow:0 0 0 3px rgba(96,165,250,.18); }

    .divider{ display:flex; align-items:center; margin:24px 0; color:var(--muted); font-size:.9rem; }
    .divider::before, .divider::after{ content:''; flex:1; height:1px; background:var(--border); }
    .divider span{ padding:0 16px; text-transform:uppercase; letter-spacing:.06em; font-size:.8rem; }

    .features{ list-style:none; padding:0; margin:0; text-align:left; }
    .features.two-col{
      display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      column-gap:20px; row-gap:8px;
    }
    .features li{
      display:flex; align-items:center; color:var(--muted); margin:8px 0;
    }
    .features li::before{ content:'✓'; color:var(--ok); font-weight:bold; margin-right:12px; font-size:1.05rem; }

    @media (max-width:480px){
      .features.two-col{ grid-template-columns: 1fr; }
    }

    .loading{ display:none; color:var(--accent); font-size:.9rem; margin-top:12px; }
    .error{ color:var(--danger); font-size:.9rem; margin-top:12px; display:none; }
    .success{ color:var(--ok); font-size:.9rem; margin-top:12px; display:none; }

    /* rodapé */
    .footer{
      max-width:500px;
      margin:32px auto 0;
      text-align:center;
      color:var(--muted-2);
      line-height:1.5;
      background: transparent;
    }
    .footer-title{
      font-weight:700;
      font-size:0.95rem;
      margin-bottom:4px;
    }
    .footer-text{
      font-size:0.85rem;
      white-space:pre-line;
    }

    @media (max-width:480px){
      .container{ padding:20px; }
      .logo{ font-size:2rem; }
      .card{ padding:24px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="logo">TI4 Game Log</div>

    <p class="subtitle">
      Create a log for your Twilight Imperium IV matches.<br/>
      Share the unique URL with your friends and track your galactic achievements together!
    </p>

    <!-- TOP FACTION (global) -->
    <div id="topFaction" class="top-faction" style="display:none">
      <img id="topFactionIcon" alt="Top faction icon" onerror="this.style.display='none'"/>
      <div id="topFactionText" class="tf-text"></div>
    </div>

    <div class="card">
      <!-- BLOCO 1: ações -->
      <section class="block" id="actions">
        <form id="createLogForm">
          <button type="submit" class="btn" id="createBtn">Create New Game Log</button>
          <div class="loading" id="loadingMessage">Creating your personalized log…</div>
          <div class="error" id="errorMessage"></div>
          <div class="success" id="successMessage"></div>
        </form>

        <div class="divider"><span>or</span></div>

        <form id="accessLogForm">
          <div class="input-group">
            <label for="logId">Existing Log ID (slug)</label>
            <input type="text" id="logId" placeholder="e.g., abc123xy" maxlength="20"/>
          </div>
          <button type="submit" class="btn secondary">Access Existing Log</button>
        </form>
      </section>

      <!-- BLOCO 2: destaques -->
      <section class="block" id="features">
        <div class="divider"><span>features</span></div>
        <ul class="features two-col">
          <li>Clean interface</li>
          <li>Auto stats / rankings</li>
          <li>Sharable unique URL</li>
          <li>Complete match history</li>
          <li>TI4 + PoK + Keleres</li>
          <li>Free to use</li>
        </ul>
      </section>
    </div>

    <!-- Rodapé -->
    <div class="footer" aria-label="Project disclaimer">
      <div class="footer-title">Conquer the Galaxy ⭐</div>
      <div class="footer-text">This project was made by a non-coder.
There is no support and your data may vanish at some point.
Sorry. = )</div>
    </div>
  </div>

  <script>
    // === Supabase client ===
    const SUPABASE_URL = 'https://zunnkdejwxoxgajhdwnn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bm5rZGVqd3hveGdhamhkd25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg3MjUsImV4cCI6MjA3MzgxNDcyNX0.P4tSLbtunxzWSXm0pOeZT7J35qvqiPU7Rp838z_nxVA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== ICON MAP / normalização =====
    const ICON_BASE = 'Faction_Icons/'; // ajuste se sua pasta tiver outro caminho
    const aliasMap = {
      // base
      'Arborec':'Arborec', 'The Arborec':'Arborec',
      'Barony of Letnev':'Letnev', 'The Barony of Letnev':'Letnev',
      'Clan of Saar':'Saar','The Clan of Saar':'Saar',
      'Embers of Muaat':'Muaat','The Embers of Muaat':'Muaat',
      'Emirates of Hacan':'Hacan','The Emirates of Hacan':'Hacan',
      'Federation of Sol':'Sol','The Federation of Sol':'Sol',
      'Ghosts of Creuss':'Creuss','The Ghosts of Creuss':'Creuss',
      'L1Z1X Mindnet':'L1Z1X','The L1Z1X Mindnet':'L1Z1X',
      'Mentak Coalition':'Mentak','The Mentak Coalition':'Mentak',
      'Naalu Collective':'Naalu','The Naalu Collective':'Naalu',
      'Nekro Virus':'Nekro','The Nekro Virus':'Nekro',
      'Sardakk N’orr':'Sardakk','Sardakk Norr':'Sardakk',
      'Universities of Jol-Nar':'JolNar','The Universities of Jol-Nar':'JolNar',
      'Winnu':'Winnu','The Winnu':'Winnu',
      'Xxcha Kingdom':'Xxcha','The Xxcha Kingdom':'Xxcha',
      'Yin Brotherhood':'Yin','The Yin Brotherhood':'Yin',
      'Yssaril Tribes':'Yssaril','The Yssaril Tribes':'Yssaril',
      // PoK
      'Argent Flight':'Argent',
      'Empyrean':'Empyrean',
      'Mahact Gene-Sorcerers':'Mahact','The Mahact Gene-Sorcerers':'Mahact',
      'Naaz-Rokha Alliance':'NaazRokha',
      'Titans of Ul':'Titans','The Titans of Ul':'Titans',
      "Vuil'raith Cabal":'Vuilraith',
      // Keleres
      'Council Keleres':'Keleres','Keleres':'Keleres'
    };
    function canonFactionName(raw){
      if(!raw) return null;
      const clean = String(raw).replace(/^the\s+/i,'').replace(/\s+/g,' ').trim();
      return aliasMap[clean] || clean;
    }
    function factionIconPath(name){
      const key = canonFactionName(name);
      if(!key) return null;
      return ICON_BASE + key + '.png';
    }

    // ===== Top winning faction (global) =====
    async function fetchTopFactionGlobal(){
      // Tenta várias estruturas comuns
      const candidates = [
        { table:'matches', col:'winner_faction' },
        { table:'match', col:'winner_faction' },
        { table:'match_results', col:'faction', filters:[['is_winner', true]] },
        { table:'results', col:'faction', filters:[['is_winner', true], ['result','win']] },
        { table:'game_results', col:'faction', filters:[['is_winner', true]] },
        { table:'games', col:'winner_faction' } // fallback fraco
      ];

      for(const c of candidates){
        try{
          let query = supabase.from(c.table).select(c.col);
          if(c.filters){
            for(const [k,v] of c.filters){
              // tenta ambos os formatos de filtro: boolean e string 'win'
              if(typeof v === 'boolean') query = query.eq(k, v);
              else query = query.eq(k, v);
            }
          }
          const { data, error } = await query;
          if(error || !Array.isArray(data) || data.length===0) continue;

          // Conta por facção em JS
          const counts = {};
          for(const row of data){
            const f = row[c.col];
            if(!f) continue;
            const k = canonFactionName(f);
            if(!k) continue;
            counts[k] = (counts[k]||0)+1;
          }
          const entries = Object.entries(counts);
          if(entries.length===0) continue;

          entries.sort((a,b)=> b[1]-a[1]);
          const [topName, wins] = entries[0];
          return { faction: topName, wins };
        }catch(e){
          // segue para o próximo candidato
          continue;
        }
      }
      return null;
    }

    async function renderTopFaction(){
      const holder = document.getElementById('topFaction');
      const iconEl = document.getElementById('topFactionIcon');
      const textEl = document.getElementById('topFactionText');

      try{
        const res = await fetchTopFactionGlobal();
        if(!res){ holder.style.display='none'; return; }

        const iconPath = factionIconPath(res.faction);
        if(iconPath){
          iconEl.src = iconPath;
          iconEl.alt = res.faction + ' icon';
          iconEl.style.display = 'block';
          iconEl.title = res.faction;
        }else{
          iconEl.style.display = 'none';
        }
        textEl.textContent = `Top current winning faction: ${res.wins} wins.`;
        holder.style.display = 'flex';
      }catch(err){
        console.error(err);
        holder.style.display='none';
      }
    }

    // ===== Ações padrão já existentes =====
    const createForm      = document.getElementById('createLogForm');
    const accessForm      = document.getElementById('accessLogForm');
    const loadingMessage  = document.getElementById('loadingMessage');
    const errorMessage    = document.getElementById('errorMessage');
    const successMessage  = document.getElementById('successMessage');
    const createBtn       = document.getElementById('createBtn');

    function showLoading(show){ loadingMessage.style.display = show ? 'block' : 'none'; createBtn.disabled = show; }
    function showError(msg){ errorMessage.textContent = msg; errorMessage.style.display = 'block'; }
    function showSuccess(msg){ successMessage.textContent = msg; successMessage.style.display = 'block'; }
    function hideMessages(){ errorMessage.style.display = 'none'; successMessage.style.display = 'none'; }

    function defaultPlaygroupName(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `Playgroup ${y}-${m}-${day}`;
    }

    createForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = defaultPlaygroupName();
      const creatorName = 'Anonymous';
      showLoading(true); hideMessages();

      try{
        const { data, error } = await supabase
          .from('games')
          .insert([ { name, creator_name: creatorName } ])
          .select('slug')
          .single();

        if(error) throw error;
        showLoading(false); showSuccess('Log created successfully! Redirecting…');
        const slug = data.slug;
        setTimeout(()=>{ window.location.href = `/log/${slug}`; }, 1200);
      }catch(err){
        console.error(err);
        showLoading(false); showError('Error creating the log. Please try again.');
      }
    });

    accessForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const slug = document.getElementById('logId').value.trim();
      if(!slug){ showError('Please enter a log ID (slug).'); return; }

      showLoading(true); hideMessages();
      try{
        const { data, error } = await supabase
          .from('games')
          .select('slug')
          .eq('slug', slug)
          .maybeSingle();

        if(error) throw error;
        if(!data) throw new Error('Log not found');

        showLoading(false); showSuccess('Log found! Redirecting…');
        setTimeout(()=>{ window.location.href = `/log/${slug}`; }, 900);
      }catch(err){
        console.error(err);
        showLoading(false); showError('Log not found. Please check the ID and try again.');
      }
    });

    // Mostra info do slug na URL (cosmético)
    const urlPath = window.location.pathname;
    const match = urlPath.match(/\/log\/([a-z0-9]{6,12})/i);
    if(match){
      const slug = match[1];
      const subtitle = document.querySelector('.subtitle');
      if (subtitle) subtitle.textContent = `Accessing log: ${slug}`;
      const logIdField = document.getElementById('logId');
      if (logIdField) logIdField.value = slug;
    }

    // Renderiza o Top Faction ao carregar
    renderTopFaction();
  </script>
</body>
</html>
