<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Twilight Imperium IV â€" Game Log</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1720;
      --panel-2: #0c131c;
      --text: #e6edf3;
      --muted: #93a0ad;
      --muted-2: #7a8896; /* cinza um pouco mais escuro para o rodapÃ© */
      --border: #1e2937;
      --accent: #60a5fa;
      --accent-2: #22d3ee;
      --ok: #10b981;
      --danger: #ef4444;
      --warn: #f59e0b;
    }
    *{ box-sizing:border-box }
    html, body{
      height:100%;
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background: linear-gradient(180deg, #0a0f14 0%, #0b1016 100%);
      color: var(--text);
    }
    .container{
      max-width:600px; margin:0 auto; padding:40px 20px; min-height:100vh;
      display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;
    }
    .logo{
      font-size:2.5rem; font-weight:800; margin-bottom:8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
    }
    .subtitle{ color:var(--muted); font-size:1.1rem; margin-bottom:20px; line-height:1.5; }

    /* Top faction stats */
    .top-faction {
      margin-bottom: 40px;
      padding: 20px;
      background: linear-gradient(180deg, rgba(96,165,250,0.08) 0%, rgba(34,211,238,0.04) 100%);
      border: 1px solid rgba(96,165,250,0.2);
      border-radius: 12px;
      max-width: 500px;
      width: 100%;
    }
    .faction-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 12px;
      border-radius: 8px;
      background: var(--panel);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .faction-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .faction-stats {
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .stats-loading {
      color: var(--accent);
      font-size: 0.85rem;
    }
    .stats-error {
      color: var(--danger);
      font-size: 0.85rem;
    }

    .card{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border); border-radius:16px; padding:32px;
      box-shadow:0 6px 22px rgba(0,0,0,.28); width:100%; max-width:500px;
    }

    /* blocos internos do card */
    .block + .block{ margin-top:24px; }

    .btn{
      background: linear-gradient(90deg, rgba(96,165,250,.18), rgba(96,165,250,.10));
      border:1px solid #334155; border-radius:12px; padding:16px 24px;
      font-size:1.1rem; color:var(--text); cursor:pointer; transition:all .15s ease;
      text-decoration:none; display:inline-block; width:100%; margin:12px 0;
    }
    .btn:hover{
      background:linear-gradient(90deg, rgba(96,165,250,.25), rgba(96,165,250,.15));
      border-color:#475569; transform:translateY(-1px);
    }
    .btn.secondary{ background:transparent; border-color:var(--border); }
    /* hover do secondary igual ao do primary */
    .btn.secondary:hover{
      background:linear-gradient(90deg, rgba(96,165,250,.25), rgba(96,165,250,.15));
      border-color:#475569; transform:translateY(-1px);
    }

    .input-group{ margin:20px 0; text-align:left; }
    .input-group label{ display:block; color:var(--muted); font-size:.9rem; margin-bottom:6px; }
    .input-group input{
      width:100%; background:#0b121a; color:var(--text); border:1px solid var(--border);
      border-radius:12px; padding:12px; font-size:1rem; outline:none;
    }
    .input-group input:focus{ border-color:#334155; box-shadow:0 0 0 3px rgba(96,165,250,.18); }

    .divider{ display:flex; align-items:center; margin:24px 0; color:var(--muted); font-size:.9rem; }
    .divider::before, .divider::after{ content:''; flex:1; height:1px; background:var(--border); }
    .divider span{ padding:0 16px; text-transform:uppercase; letter-spacing:.06em; font-size:.8rem; }

    /* features em 2 colunas */
    .features{ list-style:none; padding:0; margin:0; text-align:left; }
    .features.two-col{
      display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
      column-gap:20px; row-gap:8px;
    }
    .features li{
      display:flex; align-items:center; color:var(--muted);
      margin:8px 0;
    }
    .features li::before{
      content:'âœ"'; color:var(--ok); font-weight:bold; margin-right:12px; font-size:1.05rem;
    }
    @media (max-width:480px){
      .features.two-col{ grid-template-columns: 1fr; }
    }

    /* mensagens */
    .loading{ display:none; color:var(--accent); font-size:.9rem; margin-top:12px; }
    .error{ color:var(--danger); font-size:.9rem; margin-top:12px; display:none; }
    .success{ color:var(--ok); font-size:.9rem; margin-top:12px; display:none; }

    /* rodapÃ© */
    .footer{
      max-width:500px;
      margin:32px auto 0; /* espaÃ§amento entre o box e o inÃ­cio do texto */
      text-align:center;
      color:var(--muted-2); /* cinza um pouco mais escuro */
      line-height:1.5;
      background: transparent; /* mantÃ©m o gradiente geral */
    }
    .footer-title{
      font-weight:700;
      font-size:0.95rem; /* ligeiramente maior que o texto abaixo */
      margin-bottom:4px;
    }
    .footer-text{
      font-size:0.85rem; /* um pouco menor */
      white-space:pre-line; /* mantÃ©m quebras de linha do texto fornecido */
    }

    @media (max-width:480px){
      .container{ padding:20px; }
      .logo{ font-size:2rem; }
      .card{ padding:24px; }
    }
  </style>
  <!-- Supabase JS v2 via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="logo">TI4 Game Log</div>
    <p class="subtitle">
      Create a log for your Twilight Imperium IV matches.<br/>
      Share the unique URL with your friends and track your galactic achievements together!
    </p>

    <!-- Top Faction Stats -->
    <div class="top-faction" id="topFaction">
      <div class="faction-icon" id="factionIcon">
        <img id="factionImage" src="" alt="Top Faction" style="display: none;">
      </div>
      <div class="faction-stats" id="factionStats">
        <div class="stats-loading">Loading galactic dominance data...</div>
      </div>
    </div>

    <div class="card">
      <!-- BLOCO 1: aÃ§Ãµes (criar e acessar logs) -->
      <section class="block" id="actions">
        <!-- create log: sem campos visÃ­veis, mantÃ©m o botÃ£o e funcionalidade -->
        <form id="createLogForm">
          <button type="submit" class="btn" id="createBtn">
            Create New Game Log
          </button>
          <div class="loading" id="loadingMessage">Creating your personalized logâ€¦</div>
          <div class="error" id="errorMessage"></div>
          <div class="success" id="successMessage"></div>
        </form>

        <div class="divider"><span>or</span></div>

        <!-- acesso a log existente -->
        <form id="accessLogForm">
          <div class="input-group">
            <label for="logId">Existing Log ID (slug)</label>
            <input type="text" id="logId" placeholder="e.g., abc123xy" maxlength="20"/>
          </div>
          <button type="submit" class="btn secondary">Access Existing Log</button>
        </form>
      </section>

      <!-- BLOCO 2: destaques (features) -->
      <section class="block" id="features">
        <div class="divider"><span>features</span></div>
        <ul class="features two-col">
          <li>Clean interface</li>
          <li>Auto stats / rankings</li>
          <li>Sharable unique URL</li>
          <li>Complete match history</li>
          <li>TI4 + PoK + Keleres</li>
          <li>Free to use</li>
        </ul>
      </section>
    </div>

    <!-- RodapÃ© -->
    <div class="footer" aria-label="Project disclaimer">
      <div class="footer-title">Conquer the Galaxy â­</div>
      <div class="footer-text">This project was made by a non-coder.
There is no support and your data may vanish at some point.
Sorry. = )</div>
    </div>
  </div>

  <script>
    // === Supabase client (public URL + anon key) ===
    const SUPABASE_URL = 'https://zunnkdejwxoxgajhdwnn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bm5rZGVqd3hveGdhamhkd25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzg3MjUsImV4cCI6MjA3MzgxNDcyNX0.P4tSLbtunxzWSXm0pOeZT7J35qvqiPU7Rp838z_nxVA';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM elements
    const createForm      = document.getElementById('createLogForm');
    const accessForm      = document.getElementById('accessLogForm');
    const loadingMessage  = document.getElementById('loadingMessage');
    const errorMessage    = document.getElementById('errorMessage');
    const successMessage  = document.getElementById('successMessage');
    const createBtn       = document.getElementById('createBtn');
    const factionStats    = document.getElementById('factionStats');
    const factionImage    = document.getElementById('factionImage');

    // Faction name mapping (matching your file names)
    const factionImageMap = {
      'Arborec': 'Arborec.png',
      'Argent': 'Argent.png', 
      'Creuss': 'Creuss.png',
      'Empyrean': 'Empyrean.png',
      'Hacan': 'Hacan.png',
      'Jol-Nar': 'Jol Nar.png',
      'Keleres': 'Keleres.png',
      'L1Z1X': 'L1Z1X.png',
      'Letnev': 'Letnev.png',
      'Mahact': 'Mahact.png',
      'Mentak': 'Mentak.png',
      'Muaat': 'Muaat.png',
      'Naalu': 'Naalu.png',
      'Naaz-Rokha': 'Naaz-Rokha.png',
      'Nekro': 'Nekro.png',
      'Nomad': 'Nomad.png',
      'Saar': 'Saar.png',
      'Sardakk': 'Sardakk.png',
      'Sol': 'Sol.png',
      'Titans': 'Titans.png',
      'Vuil\'Raith': 'Vuil\'Raith.png',
      'Winnu': 'Winnu.png',
      'Xxcha': 'Xxcha.png',
      'Yin': 'Yin.png',
      'Yssaril': 'Yssaril.png'
    };

    // Load top faction stats
    async function loadTopFactionStats() {
      try {
        console.log('Loading faction stats...');
        
        // First, let's test basic connectivity
        const { data: testData, error: testError } = await supabase
          .from('games')
          .select('*')
          .limit(1);

        console.log('Test query result:', { testData, testError });

        if (testError) {
          throw new Error(`Database connection error: ${testError.message}`);
        }

        // Query to get all game_players data to debug
        const { data: allPlayersData, error: playersError } = await supabase
          .from('game_players')
          .select('*')
          .limit(10);

        console.log('All players data sample:', { allPlayersData, playersError });

        // Query to get faction win counts
        const { data: winData, error: winError } = await supabase
          .from('game_players')
          .select('faction, winner')
          .eq('winner', true);

        console.log('Win data:', { winData, winError });

        if (winError) {
          throw new Error(`Win data query error: ${winError.message}`);
        }

        // Query to get total games count
        const { data: gameData, error: gameError } = await supabase
          .from('games')
          .select('id');

        console.log('Game data:', { gameData, gameError });

        if (gameError) {
          throw new Error(`Game data query error: ${gameError.message}`);
        }

        if (!winData || winData.length === 0) {
          // No winners found, let's show most played faction instead
          const { data: allPlayersData } = await supabase
            .from('game_players')
            .select('faction');
          
          console.log('All players for most played:', allPlayersData);
          
          if (allPlayersData && allPlayersData.length > 0) {
            // Count games by faction instead of wins
            const factionGames = {};
            allPlayersData.forEach(row => {
              const faction = row.faction;
              if (faction) {
                factionGames[faction] = (factionGames[faction] || 0) + 1;
              }
            });

            // Find most played faction
            let topFaction = null;
            let maxGames = 0;
            for (const [faction, games] of Object.entries(factionGames)) {
              if (games > maxGames) {
                maxGames = games;
                topFaction = faction;
              }
            }

            if (topFaction) {
              // Display faction image
              const imageName = factionImageMap[topFaction];
              if (imageName) {
                factionImage.src = `/Faction_Icons/${imageName}`;
                factionImage.alt = topFaction;
                factionImage.style.display = 'block';
                factionImage.onerror = function() {
                  this.style.display = 'none';
                  this.parentElement.innerHTML = `<div style="font-size: 24px; color: var(--accent);">${topFaction.charAt(0)}</div>`;
                };
              } else {
                factionImage.style.display = 'none';
                factionImage.parentElement.innerHTML = `<div style="font-size: 24px; color: var(--accent);">${topFaction.charAt(0)}</div>`;
              }

              const totalGames = gameData ? gameData.length : 0;
              factionStats.innerHTML = `
                <strong>Most played faction across all games</strong><br/>
                <span style="color: var(--accent); font-weight: 600;">${topFaction}</span> - ${maxGames} times played over ${totalGames} games<br/>
                <small style="color: var(--muted);">*No winners marked yet - showing most played instead</small>
              `;
              return;
            }
          }
          
          factionStats.innerHTML = `
            <div class="stats-error">
              No winning data found yet.<br/>
              Total games in database: ${gameData ? gameData.length : 0}<br/>
              Please mark winners in your games to see faction statistics.
            </div>`;
          return;
        }

        // Count wins by faction
        const factionWins = {};
        winData.forEach(row => {
          const faction = row.faction;
          if (faction) {
            factionWins[faction] = (factionWins[faction] || 0) + 1;
          }
        });

        console.log('Faction wins:', factionWins);

        // Find top faction
        let topFaction = null;
        let maxWins = 0;
        for (const [faction, wins] of Object.entries(factionWins)) {
          if (wins > maxWins) {
            maxWins = wins;
            topFaction = faction;
          }
        }

        if (topFaction) {
          // Display faction image
          const imageName = factionImageMap[topFaction];
          if (imageName) {
            factionImage.src = `/Faction_Icons/${imageName}`;
            factionImage.alt = topFaction;
            factionImage.style.display = 'block';
            factionImage.onerror = function() {
              // Fallback if image doesn't load
              this.style.display = 'none';
              this.parentElement.innerHTML = `<div style="font-size: 24px; color: var(--accent);">${topFaction.charAt(0)}</div>`;
            };
          } else {
            // No image mapping found
            factionImage.style.display = 'none';
            factionImage.parentElement.innerHTML = `<div style="font-size: 24px; color: var(--accent);">${topFaction.charAt(0)}</div>`;
          }

          // Display stats
          const totalGames = gameData ? gameData.length : 0;
          factionStats.innerHTML = `
            <strong>Current top winning faction across all games</strong><br/>
            <span style="color: var(--accent); font-weight: 600;">${topFaction}</span> - ${maxWins} wins over ${totalGames} games
          `;
        } else {
          factionStats.innerHTML = '<div class="stats-error">No faction data could be processed.</div>';
        }

      } catch (error) {
        console.error('Error loading faction stats:', error);
        factionStats.innerHTML = `
          <div class="stats-error">
            Unable to load stats: ${error.message}<br/>
            <small>Check browser console for details.</small>
          </div>`;
      }
    }

    // Load stats on page load
    loadTopFactionStats();

    // Helpers
    function showLoading(show){
      loadingMessage.style.display = show ? 'block' : 'none';
      createBtn.disabled = show;
    }
    function showError(msg){
      errorMessage.textContent = msg;
      errorMessage.style.display = 'block';
    }
    function showSuccess(msg){
      successMessage.textContent = msg;
      successMessage.style.display = 'block';
    }
    function hideMessages(){
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';
    }

    // Gera valores padrÃµes jÃ¡ que removemos os campos visuais
    function defaultPlaygroupName(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `Playgroup ${y}-${m}-${day}`;
    }

    // Create new game log (INSERT into public.games and get slug back)
    createForm.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const name = defaultPlaygroupName();       // valor padrÃ£o
      const creatorName = 'Anonymous';           // valor padrÃ£o

      showLoading(true);
      hideMessages();

      try{
        const { data, error } = await supabase
          .from('games')
          .insert([ { name, creator_name: creatorName } ])
          .select('slug')
          .single();

        if(error) throw error;

        showLoading(false);
        showSuccess('Log created successfully! Redirectingâ€¦');

        const slug = data.slug;
        setTimeout(()=>{ window.location.href = `/log/${slug}`; }, 1200);

      }catch(err){
        console.error(err);
        showLoading(false);
        showError('Error creating the log. Please try again.');
      }
    });

    // Access existing log (SELECT by slug)
    accessForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const slug = document.getElementById('logId').value.trim();

      if(!slug){
        showError('Please enter a log ID (slug).');
        return;
      }

      showLoading(true);
      hideMessages();

      try{
        const { data, error } = await supabase
          .from('games')
          .select('slug')
          .eq('slug', slug)
          .maybeSingle();

        if(error) throw error;
        if(!data){ throw new Error('Log not found'); }

        showLoading(false);
        showSuccess('Log found! Redirectingâ€¦');
        setTimeout(()=>{ window.location.href = `/log/${slug}`; }, 900);

      }catch(err){
        console.error(err);
        showLoading(false);
        showError('Log not found. Please check the ID and try again.');
      }
    });

    // If URL already contains /log/<id>, reflect it on the page (cosmetic)
    const urlPath = window.location.pathname;
    const match = urlPath.match(/\/log\/([a-z0-9]{6,12})/i);
    if(match){
      const slug = match[1];
      const subtitle = document.querySelector('.subtitle');
      if (subtitle) subtitle.textContent = `Accessing log: ${slug}`;
      const logIdField = document.getElementById('logId');
      if (logIdField) logIdField.value = slug;
    }
  </script>
</body>
</html>
